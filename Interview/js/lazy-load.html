<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, minimal-ui">
    <meta name="theme-color" content="#000000">

    <title>lazy-load</title>
</head>
<style>
    #main {
        width: 700px;
        margin: 0 auto;
    }

    .view {
        width: 300px;
        float: left;
        margin: 0 auto;
    }

    .lazyload-image {
        position: relative;
        filter: blur(30px);
        filter: progid:DXImageTransform.Microsoft.Blur(PixelRadius='50', MakeShadow=false);
        transition: filter 0.7s ease;
        left: 50%;
        transform: translateX(-50%);
    }

    .lazyload-container {
        position: relative;
        margin: 0 0 30px 0;
        padding: 10px 0;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        cursor: pointer;
    }

    .lazyload-container:hover:before {
        content: '';
        width: 100%;
        height: 100%;
        background: rgba(0, 2, 4, 0.2);
        position: absolute;
        top: 0;
        left: 0;
        display: block;
        z-index: 100;
        border-radius: 8px;
    }

    .loaded {
        filter: none;
    }
</style>

<body>
    <div id="main">
        <div class="view">
            <div class="lazyload-container" data-src="https://ci.xiaohongshu.com/e637110f-406d-4414-8556-37cbcbba0f6c@r_640w_640h.jpg">
                <img class="lazyloading lazyload-image">
            </div>
            <div class="lazyload-container" data-src="https://ci.xiaohongshu.com/1a3dc898-bb37-4667-861a-f3f4565b64a0@r_640w_640h.jpg">
                <img class="lazyloading lazyload-image">
            </div>
            <div class="lazyload-container" data-src="https://ci.xiaohongshu.com/1739328c-8955-495e-aeb2-5bf6b01a244f@r_640w_640h.jpg">
                <img class="lazyloading lazyload-image">
            </div>
            <div class="lazyload-container" data-src="https://ci.xiaohongshu.com/e10d7a72-6e1b-49f2-9232-2b42c09d5c84@r_640w_640h.jpg">
                <img class="lazyloading lazyload-image">
            </div>
            <div class="lazyload-container" data-src="https://ci.xiaohongshu.com/56d68404-1e31-45af-8438-c258b788be3b@r_640w_640h.jpg">
                <img class="lazyloading lazyload-image">
            </div>
            <div class="lazyload-container" data-src="https://ci.xiaohongshu.com/9d5ed004-0142-4648-a310-c91d32b2e8bd@r_640w_640h.jpg">
                <img class="lazyloading lazyload-image">
            </div>
            <div class="lazyload-container" data-src="https://ci.xiaohongshu.com/ac07fe30-67ba-4377-807c-cb1885f75e1e@r_640w_640h.jpg">
                <img class="lazyloading lazyload-image">
            </div>
            <div class="lazyload-container" data-src="https://ci.xiaohongshu.com/83db10c2-8d6b-4c4b-90b9-36502b6a23cc@r_640w_640h.jpg">
                <img class="lazyloading lazyload-image">
            </div>
            <div class="lazyload-container" data-src="https://ci.xiaohongshu.com/12c16441-bede-4865-8ce0-0a41c6443225@r_640w_640h.jpg">
                <img class="lazyloading lazyload-image">
            </div>
        </div>
        <div class="view">
            <div class="lazyload-container" data-src="http://ci.xiaohongshu.com/f8f9df7a-88de-4ffb-ba25-440aa423eb77@r_640w_640h.jpg">
                <img class="lazyloading lazyload-image">
            </div>
            <div class="lazyload-container" data-src="http://ci.xiaohongshu.com/49a10ea2-bcda-4c01-ae5c-df8bead2ac6d@r_640w_640h.jpg">
                <img class="lazyloading lazyload-image">
            </div>
            <div class="lazyload-container" data-src="https://ci.xiaohongshu.com/1739328c-8955-495e-aeb2-5bf6b01a244f@r_640w_640h.jpg">
                <img class="lazyloading lazyload-image">
            </div>
            <div class="lazyload-container" data-src="https://ci.xiaohongshu.com/e10d7a72-6e1b-49f2-9232-2b42c09d5c84@r_640w_640h.jpg">
                <img class="lazyloading lazyload-image">
            </div>
            <div class="lazyload-container" data-src="https://ci.xiaohongshu.com/56d68404-1e31-45af-8438-c258b788be3b@r_640w_640h.jpg">
                <img class="lazyloading lazyload-image">
            </div>
            <div class="lazyload-container" data-src="https://ci.xiaohongshu.com/9d5ed004-0142-4648-a310-c91d32b2e8bd@r_640w_640h.jpg">
                <img class="lazyloading lazyload-image">
            </div>
            <div class="lazyload-container" data-src="https://ci.xiaohongshu.com/ac07fe30-67ba-4377-807c-cb1885f75e1e@r_640w_640h.jpg">
                <img class="lazyloading lazyload-image">
            </div>
            <div class="lazyload-container" data-src="http://ci.xiaohongshu.com/c443bf8b-9329-4386-bbe5-35279f6aa5ad@r_640w_640h.jpg">
                <img class="lazyloading lazyload-image">
            </div>
            <div class="lazyload-container" data-src="http://ci.xiaohongshu.com/2825c5f0-6e7e-4566-b249-d92a4cd370ed@r_640w_640h.jpg">
                <img class="lazyloading lazyload-image">
            </div>
        </div>
    </div>
</body>

<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
        let containers = document.querySelectorAll('.lazyload-container');
        Array.from(containers).forEach(container => {
            let img = container.children[0];
            let [width, height] = container.dataset.src.match(/\d*w_\d*/)[0].split('w_')
            img.style.width = 250 + 'px';
            img.style.height = height * (Math.random() * 0.2 + 0.4) + 'px';
        })
        isInSight();
    })
    function throttle(fn, wait, options) {
        let previous = 0;
        let timeout = null;
        return function (...argvs) {
            let current = new Date().getTime();
            let ctx = this;
            if (current - previous > wait) {
                previous = current;
                if (timeout) {
                    clearTimeout(timeout);
                    timeout = null;
                }
                return fn.apply(ctx, argvs);
            } else if (!timeout) {
                timeout = setTimeout(function () { fn.apply(ctx, argvs) }, wait);
            }
        }
    }
    function isInSight() {
        let imgs = document.querySelectorAll('.lazyloading');
        Array.from(imgs).forEach(img => {
            let scrollTop = document.body.scrollTop || document.documentElement.scrollTop;
            let winHeight = window.innerHeight;
            let height = img.offsetHeight;
            let offsetTop = getTop(img); //不设置position时offset为正常值，relative不正常
            if (offsetTop + height > scrollTop && offsetTop < scrollTop + winHeight) {
                img.src = img.parentElement.dataset.src;
                img.onload = function () {
                    img.classList.add('loaded')
                    img.classList.remove('lazyloading')
                }
            }
        })
        function getTop(el) {
            let top = 0;
            while (el != document.body) {
                top = el.offsetTop;
                el = el.offsetParent;
            }
            return top
        }
    }
    window.onscroll = throttle(isInSight, 300);
</script>

</html>